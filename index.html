<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pan India Projects Tracker</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #e63946;
            --primary-dark: #c1121f;
            --primary-light: #ff8fa3;
            --secondary: #457b9d;
            --light: #f1faee;
            --dark: #1d3557;
            --gray: #a8a8a8;
            --white: #ffffff;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #fafafa;
            color: var(--dark);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2rem;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            flex: 1;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card h3 {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .stat-card i {
            font-size: 1.5rem;
            background-color: var(--primary-light);
            color: var(--primary);
            padding: 10px;
            border-radius: 50%;
            margin-bottom: 15px;
        }
        
        .filters {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .filter-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .filter-title h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .filter-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .filter-group input, .filter-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(230, 57, 70, 0.2);
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-secondary {
            background-color: var(--light);
            color: var(--dark);
        }
        
        .btn-secondary:hover {
            background-color: #e5e5e5;
        }
        
        .projects-container {
            margin-top: 30px;
        }
        
        .projects-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .projects-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .upload-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: var(--secondary);
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .upload-btn:hover {
            background-color: #3d6e8c;
        }
        
        .upload-btn input {
            display: none;
        }
        
        .download-template {
            color: var(--secondary);
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .download-template:hover {
            text-decoration: underline;
        }
        
        .project-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .project-table th, .project-table td {
            padding: 16px;
            text-align: left;
        }
        
        .project-table th {
            background-color: #f8f8f8;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 1px solid #eee;
        }
        
        .project-table tr {
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        
        .project-table tr:last-child {
            border-bottom: none;
        }
        
        .project-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .status-completed {
            background-color: #e3f9e5;
            color: #1b891b;
        }
        
        .status-in-progress {
            background-color: #fff8e6;
            color: #b7791f;
        }
        
        .status-planning {
            background-color: #e6f4ff;
            color: #1a73e8;
        }
        
        .status-delayed {
            background-color: #ffeaea;
            color: #e53935;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }
        
        .pagination button {
            width: 40px;
            height: 40px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pagination button.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .pagination button:hover:not(.active) {
            background-color: #f5f5f5;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
        }
        
        .empty-state i {
            font-size: 4rem;
            color: var(--gray);
            margin-bottom: 20px;
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .empty-state p {
            color: var(--gray);
            margin-bottom: 20px;
        }

        /* Notification styles */
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--primary);
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
        }

        .data-management {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Auth container styles */
        .auth-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .loading-indicator {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Last sync info */
        .sync-info {
            text-align: right;
            color: var(--gray);
            font-size: 0.8rem;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .stats {
                flex-direction: column;
            }
            
            .filter-content {
                grid-template-columns: 1fr;
            }
            
            .projects-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .project-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <img src="/api/placeholder/100/100" alt="Logo" height="100">
                    <h1>Pan India Projects Tracker</h1>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Authentication Container -->
        <div class="auth-container" id="auth-container">
            <h2>Sign in to access shared project data</h2>
            <p>Sign in to view and contribute to the shared project database</p>
            <div class="auth-buttons">
                <button class="btn btn-primary" id="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
            </div>
        </div>
        
        <div id="user-container" style="display: none;">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar"></div>
                <div>
                    <div id="user-name">User Name</div>
                    <div class="sync-info">Last synced: <span id="last-synced">Never</span></div>
                </div>
                <button class="btn btn-secondary" id="logout-btn" style="margin-left: auto;">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
            </div>
        </div>

        <div class="loading-indicator" id="loading-indicator">
            <div class="loading-spinner"></div>
            <p>Loading project data...</p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <i class="fas fa-tasks"></i>
                <h3>Total Projects</h3>
                <div class="value" id="total-projects">0</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-spinner"></i>
                <h3>In Progress</h3>
                <div class="value" id="in-progress">0</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-check-circle"></i>
                <h3>Completed</h3>
                <div class="value" id="completed">0</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-clipboard-list"></i>
                <h3>Planning</h3>
                <div class="value" id="planning">0</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-clock"></i>
                <h3>Delayed</h3>
                <div class="value" id="delayed">0</div>
            </div>
        </div>
        
        <div class="filters">
            <div class="filter-title">
                <h2>Filter Projects</h2>
            </div>
            <div class="filter-content">
                <div class="filter-group">
                    <label for="project-name">Project Name</label>
                    <input type="text" id="project-name" placeholder="Search by project name">
                </div>
                <div class="filter-group">
                    <label for="company-name">Company Name</label>
                    <input type="text" id="company-name" placeholder="Search by company name">
                </div>
                <div class="filter-group">
                    <label for="company-location">Company Location</label>
                    <input type="text" id="company-location" placeholder="Search by company location">
                </div>
                <div class="filter-group">
                    <label for="budget">Budget Range (Cr ₹)</label>
                    <select id="budget">
                        <option value="">All Budgets</option>
                        <option value="0-10">0 - 10 Cr</option>
                        <option value="10-50">10 - 50 Cr</option>
                        <option value="50-100">50 - 100 Cr</option>
                        <option value="100-500">100 - 500 Cr</option>
                        <option value="500+">500+ Cr</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="site-location">Site Location</label>
                    <input type="text" id="site-location" placeholder="Search by site location">
                </div>
                <div class="filter-group">
                    <label for="status">Status</label>
                    <select id="status">
                        <option value="">All Status</option>
                        <option value="Completed">Completed</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Planning">Planning</option>
                        <option value="Delayed">Delayed</option>
                    </select>
                </div>
            </div>
            <div class="actions">
                <button class="btn btn-secondary" id="reset-filters">Reset Filters</button>
                <button class="btn btn-primary" id="apply-filters">Apply Filters</button>
            </div>
            <div class="filter-results" id="filter-results" style="display: none; margin-top: 15px; padding: 10px; background-color: #f8f8f8; border-radius: 6px;">
                <span><strong>Filtered Results:</strong> <span id="filtered-count">0</span> projects found</span>
            </div>
        </div>
        
        <div class="projects-container">
            <div class="projects-header">
                <h2>Projects List</h2>
                <div class="upload-container">
                    <label class="upload-btn">
                        <i class="fas fa-upload"></i>
                        Upload Excel
                        <input type="file" id="excel-upload" accept=".xlsx, .xls, .csv">
                    </label>
                    <a href="#" class="download-template" id="download-template">
                        <i class="fas fa-file-download"></i>
                        Download Template
                    </a>
                </div>
            </div>
            
            <div class="data-management">
                <button class="btn btn-secondary" id="export-data">
                    <i class="fas fa-file-export"></i> Export Data
                </button>
                <button class="btn btn-secondary" id="sync-data" disabled>
                    <i class="fas fa-sync-alt"></i> Sync Data
                </button>
                <button class="btn btn-secondary" id="clear-data">
                    <i class="fas fa-trash-alt"></i> Clear All Data
                </button>
            </div>
            
            <div id="projects-table-container">
                <div class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <h3>No Projects Found</h3>
                    <p>Sign in and upload an Excel file with project data or click on the sample data button below</p>
                    <button class="btn btn-primary" id="load-sample">Load Sample Data</button>
                </div>
            </div>
            
            <div class="pagination" id="pagination">
                <!-- Pagination buttons will be added dynamically -->
            </div>
        </div>
    </div>
    
    <!-- Notification element -->
    <div id="notification" style="display: none;">
        <span id="notification-message">Data saved successfully!</span>
    </div>
    
    <!-- Import Firebase SDK scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // Firebase configuration
        // IMPORTANT: Replace these with your own Firebase project credentials
        const firebaseConfig = {
  apiKey: "AIzaSyBUZmbKVXhMKRtr6knK7nd3WfG4GcUJc2I",
  authDomain: "projectssml.firebaseapp.com",
  projectId: "projectssml",
  storageBucket: "projectssml.firebasestorage.app",
  messagingSenderId: "525806025941",
  appId: "1:525806025941:web:99f4c25341815e73ddb65c",
  measurementId: "G-WJ3D02H6V5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Get Firebase services
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Sample data for demonstration
        const sampleData = [
            {
                id: 1,
                projectName: "Mumbai Metro Line 3",
                companyName: "Mumbai Metro Rail Corporation",
                companyLocation: "Mumbai, Maharashtra",
                budget: 231.36,
                siteLocation: "Colaba-Bandra-SEEPZ, Mumbai",
                status: "In Progress"
            },
            {
                id: 2,
                projectName: "Delhi-Meerut RRTS",
                companyName: "National Capital Region Transport Corporation",
                companyLocation: "Delhi",
                budget: 300.00,
                siteLocation: "Delhi-Meerut Corridor",
                status: "In Progress"
            },
            {
                id: 3,
                projectName: "Statue of Unity",
                companyName: "Larsen & Toubro",
                companyLocation: "Mumbai, Maharashtra",
                budget: 29.89,
                siteLocation: "Kevadia, Gujarat",
                status: "Completed"
            },
            {
                id: 4,
                projectName: "Bharatmala Pariyojana Phase I",
                companyName: "National Highways Authority of India",
                companyLocation: "New Delhi",
                budget: 535.00,
                siteLocation: "Pan India",
                status: "In Progress"
            },
            {
                id: 5,
                projectName: "Navi Mumbai International Airport",
                companyName: "Adani Group",
                companyLocation: "Ahmedabad, Gujarat",
                budget: 160.00,
                siteLocation: "Navi Mumbai, Maharashtra",
                status: "Planning"
            },
            {
                id: 6,
                projectName: "Mumbai Coastal Road",
                companyName: "Municipal Corporation of Greater Mumbai",
                companyLocation: "Mumbai, Maharashtra",
                budget: 126.21,
                siteLocation: "South Mumbai to Northern Suburbs",
                status: "In Progress"
            },
            {
                id: 7,
                projectName: "Chennai Metro Phase II",
                companyName: "Chennai Metro Rail Limited",
                companyLocation: "Chennai, Tamil Nadu",
                budget: 619.68,
                siteLocation: "Chennai Metropolitan Area",
                status: "Planning"
            },
            {
                id: 8,
                projectName: "Amaravati Capital City",
                companyName: "Andhra Pradesh Capital Region Development Authority",
                companyLocation: "Vijayawada, Andhra Pradesh",
                budget: 500.00,
                siteLocation: "Amaravati, Andhra Pradesh",
                status: "Delayed"
            },
            {
                id: 9,
                projectName: "Bullet Train Project",
                companyName: "National High Speed Rail Corporation Limited",
                companyLocation: "New Delhi",
                budget: 1080.00,
                siteLocation: "Mumbai-Ahmedabad",
                status: "In Progress"
            },
            {
                id: 10,
                projectName: "Atal Mission for Rejuvenation and Urban Transformation",
                companyName: "Ministry of Housing and Urban Affairs",
                companyLocation: "New Delhi",
                budget: 77.30,
                siteLocation: "500 cities across India",
                status: "In Progress"
            },
            {
                id: 11,
                projectName: "Pragati Maidan Redevelopment",
                companyName: "India Trade Promotion Organisation",
                companyLocation: "New Delhi",
                budget: 28.22,
                siteLocation: "New Delhi",
                status: "Completed"
            },
            {
                id: 12,
                projectName: "Eastern Dedicated Freight Corridor",
                companyName: "Dedicated Freight Corridor Corporation of India",
                companyLocation: "New Delhi",
                budget: 302.74,
                siteLocation: "Punjab-West Bengal",
                status: "In Progress"
            },
            {
                id: 13,
                projectName: "Nagpur Metro",
                companyName: "Maharashtra Metro Rail Corporation",
                companyLocation: "Nagpur, Maharashtra",
                budget: 86.80,
                siteLocation: "Nagpur, Maharashtra",
                status: "Completed"
            },
            {
                id: 14,
                projectName: "Polavaram Irrigation Project",
                companyName: "Water Resources Department, Andhra Pradesh",
                companyLocation: "Amaravati, Andhra Pradesh",
                budget: 550.48,
                siteLocation: "West Godavari, Andhra Pradesh",
                status: "Delayed"
            },
            {
                id: 15,
                projectName: "GIFT City",
                companyName: "Gujarat International Finance Tec-City Company Ltd",
                companyLocation: "Gandhinagar, Gujarat",
                budget: 780.00,
                siteLocation: "Gandhinagar, Gujarat",
                status: "In Progress"
            }
        ];

        let allProjects = [];
        let filteredProjects = [];
        let currentPage = 1;
        const projectsPerPage = 10;
        let currentUser = null;
        
        // DOM Elements
        const projectNameFilter = document.getElementById('project-name');
        const companyNameFilter = document.getElementById('company-name');
        const companyLocationFilter = document.getElementById('company-location');
        const budgetFilter = document.getElementById('budget');
        const siteLocationFilter = document.getElementById('site-location');
        const statusFilter = document.getElementById('status');
        const resetFiltersBtn = document.getElementById('reset-filters');
        const applyFiltersBtn = document.getElementById('apply-filters');
        const loadSampleBtn = document.getElementById('load-sample');
        const excelUpload = document.getElementById('excel-upload');
        const downloadTemplateBtn = document.getElementById('download-template');
        const projectsTableContainer = document.getElementById('projects-table-container');
        const paginationContainer = document.getElementById('pagination');
        const exportDataBtn = document.getElementById('export-data');
        const clearDataBtn = document.getElementById('clear-data');
        const syncDataBtn = document.getElementById('sync-data');

        // Auth elements
        const authContainer = document.getElementById('auth-container');
        const userContainer = document.getElementById('user-container');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const lastSynced = document.getElementById('last-synced');
        const loadingIndicator = document.getElementById('loading-indicator');

        // Statistics elements
        const totalProjectsElement = document.getElementById('total-projects');
        const inProgressElement = document.getElementById('in-progress');
        const completedElement = document.getElementById('completed');
        const planningElement = document.getElementById('planning');
        const delayedElement = document.getElementById('delayed');
        
        // Firebase Authentication Functions
        function signIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    // User successfully signed in
                    showNotification('Signed in successfully!');
                })
                .catch((error) => {
                    console.error('Error signing in:', error);
                    showNotification('Error signing in. Please try again.', 'error');
                });
        }

        function signOut() {
            auth.signOut()
                .then(() => {
                    showNotification('Signed out successfully!');
                })
                .catch((error) => {
                    console.error('Error signing out:', error);
                    showNotification('Error signing out. Please try again.', 'error');
                });
        }

        // Firebase Database Functions
        function saveProjectsToFirebase(projects) {
    if (!currentUser) {
        showNotification('Please sign in to save data', 'error');
        return Promise.reject('User not authenticated');
    }
    
    showNotification('Saving data to cloud...');
    
    // Create a reference to this user's projects
    const userProjectsRef = database.ref('users/' + currentUser.uid + '/projects');
    
    // Set the projects data to replace any existing data
    return userProjectsRef.set(projects)
        .then(() => {
            // Update the last synced timestamp
            const timestamp = new Date().toLocaleString();
            database.ref('users/' + currentUser.uid + '/lastSynced').set(timestamp);
            lastSynced.textContent = timestamp;
            
            showNotification('Data saved to cloud successfully!');
            syncDataBtn.disabled = false;
            return projects;
        })
        .catch(error => {
            console.error('Error saving data to Firebase:', error);
            showNotification('Error saving data to cloud', 'error');
            throw error;
        });
}

function loadProjectsFromFirebase() {
    if (!currentUser) {
        return Promise.resolve([]);
    }
    
    showLoading(true);
    
    // Create a reference to this user's projects
    const userProjectsRef = database.ref('users/' + currentUser.uid + '/projects');
    
    // Get the data
    return userProjectsRef.once('value')
        .then(snapshot => {
            const projects = snapshot.val() || [];
            
            // Get the last synced timestamp
            return database.ref('users/' + currentUser.uid + '/lastSynced').once('value')
                .then(syncSnapshot => {
                    const timestamp = syncSnapshot.val() || 'Never';
                    lastSynced.textContent = timestamp;
                    
                    showLoading(false);
                    return projects;
                });
        })
        .catch(error => {
            console.error('Error loading data from Firebase:', error);
            showNotification('Error loading data from cloud', 'error');
            showLoading(false);
            return [];
        });
}

// Helper Functions
function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    const notificationMessage = document.getElementById('notification-message');
    
    notification.style.backgroundColor = type === 'success' ? 'var(--primary)' : 'var(--primary-dark)';
    notificationMessage.textContent = message;
    
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

function showLoading(show) {
    loadingIndicator.style.display = show ? 'block' : 'none';
}

function updateStatistics() {
    const totalProjects = allProjects.length;
    const inProgress = allProjects.filter(p => p.status === 'In Progress').length;
    const completed = allProjects.filter(p => p.status === 'Completed').length;
    const planning = allProjects.filter(p => p.status === 'Planning').length;
    const delayed = allProjects.filter(p => p.status === 'Delayed').length;
    
    totalProjectsElement.textContent = totalProjects;
    inProgressElement.textContent = inProgress;
    completedElement.textContent = completed;
    planningElement.textContent = planning;
    delayedElement.textContent = delayed;
}

function filterProjects() {
    const projectName = projectNameFilter.value.toLowerCase();
    const companyName = companyNameFilter.value.toLowerCase();
    const companyLocation = companyLocationFilter.value.toLowerCase();
    const budget = budgetFilter.value;
    const siteLocation = siteLocationFilter.value.toLowerCase();
    const status = statusFilter.value;
    
    filteredProjects = allProjects.filter(project => {
        // Project name filter
        if (projectName && !project.projectName.toLowerCase().includes(projectName)) {
            return false;
        }
        
        // Company name filter
        if (companyName && !project.companyName.toLowerCase().includes(companyName)) {
            return false;
        }
        
        // Company location filter
        if (companyLocation && !project.companyLocation.toLowerCase().includes(companyLocation)) {
            return false;
        }
        
        // Site location filter
        if (siteLocation && !project.siteLocation.toLowerCase().includes(siteLocation)) {
            return false;
        }
        
        // Status filter
        if (status && project.status !== status) {
            return false;
        }
        
        // Budget filter
        if (budget) {
            const projectBudget = parseFloat(project.budget);
            
            switch (budget) {
                case '0-10':
                    if (projectBudget < 0 || projectBudget > 10) return false;
                    break;
                case '10-50':
                    if (projectBudget < 10 || projectBudget > 50) return false;
                    break;
                case '50-100':
                    if (projectBudget < 50 || projectBudget > 100) return false;
                    break;
                case '100-500':
                    if (projectBudget < 100 || projectBudget > 500) return false;
                    break;
                case '500+':
                    if (projectBudget < 500) return false;
                    break;
            }
        }
        
        return true;
    });
    
    document.getElementById('filtered-count').textContent = filteredProjects.length;
    document.getElementById('filter-results').style.display = 'block';
    
    currentPage = 1;
    renderProjects();
}

function resetFilters() {
    projectNameFilter.value = '';
    companyNameFilter.value = '';
    companyLocationFilter.value = '';
    budgetFilter.value = '';
    siteLocationFilter.value = '';
    statusFilter.value = '';
    
    filteredProjects = [...allProjects];
    document.getElementById('filter-results').style.display = 'none';
    
    currentPage = 1;
    renderProjects();
}

function getStatusClass(status) {
    switch (status) {
        case 'Completed':
            return 'status-completed';
        case 'In Progress':
            return 'status-in-progress';
        case 'Planning':
            return 'status-planning';
        case 'Delayed':
            return 'status-delayed';
        default:
            return '';
    }
}

function renderProjects() {
    const projectsToShow = filteredProjects || allProjects;
    
    // Clear the container
    projectsTableContainer.innerHTML = '';
    
    if (projectsToShow.length === 0) {
        // Show empty state
        projectsTableContainer.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-folder-open"></i>
                <h3>No Projects Found</h3>
                <p>Upload an Excel file with project data or click on the sample data button below</p>
                <button class="btn btn-primary" id="load-sample">Load Sample Data</button>
            </div>
        `;
        
        // Add event listener to the new load sample button
        document.getElementById('load-sample').addEventListener('click', loadSampleData);
        
        // Hide pagination
        paginationContainer.style.display = 'none';
        return;
    }
    
    // Calculate pagination
    const totalPages = Math.ceil(projectsToShow.length / projectsPerPage);
    const startIndex = (currentPage - 1) * projectsPerPage;
    const endIndex = Math.min(startIndex + projectsPerPage, projectsToShow.length);
    const currentProjects = projectsToShow.slice(startIndex, endIndex);
    
    // Create the table
    const table = document.createElement('table');
    table.className = 'project-table';
    
    // Create table header
    const thead = document.createElement('thead');
    thead.innerHTML = `
        <tr>
            <th>Project Name</th>
            <th>Company Name</th>
            <th>Company Location</th>
            <th>Budget (Cr ₹)</th>
            <th>Site Location</th>
            <th>Status</th>
        </tr>
    `;
    table.appendChild(thead);
    
    // Create table body
    const tbody = document.createElement('tbody');
    
    currentProjects.forEach(project => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${project.projectName}</td>
            <td>${project.companyName}</td>
            <td>${project.companyLocation}</td>
            <td>${project.budget.toFixed(2)}</td>
            <td>${project.siteLocation}</td>
            <td><span class="status ${getStatusClass(project.status)}">${project.status}</span></td>
        `;
        tbody.appendChild(tr);
    });
    
    table.appendChild(tbody);
    projectsTableContainer.appendChild(table);
    
    // Render pagination
    renderPagination(totalPages);
    paginationContainer.style.display = 'flex';
}

function renderPagination(totalPages) {
    paginationContainer.innerHTML = '';
    
    // Previous button
    const prevButton = document.createElement('button');
    prevButton.innerHTML = '&laquo;';
    prevButton.disabled = currentPage === 1;
    prevButton.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderProjects();
        }
    });
    paginationContainer.appendChild(prevButton);
    
    // Page buttons
    for (let i = 1; i <= totalPages; i++) {
        const pageButton = document.createElement('button');
        pageButton.textContent = i;
        pageButton.className = i === currentPage ? 'active' : '';
        pageButton.addEventListener('click', () => {
            currentPage = i;
            renderProjects();
        });
        paginationContainer.appendChild(pageButton);
    }
    
    // Next button
    const nextButton = document.createElement('button');
    nextButton.innerHTML = '&raquo;';
    nextButton.disabled = currentPage === totalPages;
    nextButton.addEventListener('click', () => {
        if (currentPage < totalPages) {
            currentPage++;
            renderProjects();
        }
    });
    paginationContainer.appendChild(nextButton);
}

function loadSampleData() {
    allProjects = JSON.parse(JSON.stringify(sampleData)); // Deep copy
    filteredProjects = [...allProjects];
    
    updateStatistics();
    renderProjects();
    
    // If user is signed in, save to Firebase
    if (currentUser) {
        saveProjectsToFirebase(allProjects);
    }
    
    showNotification('Sample data loaded successfully!');
}

function handleExcelUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const data = e.target.result;
            const workbook = XLSX.read(data, { type: 'binary' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // Convert to JSON
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            // Validate and transform data
            const processedData = jsonData.map((row, index) => {
                return {
                    id: index + 1,
                    projectName: row['Project Name'] || 'Untitled Project',
                    companyName: row['Company Name'] || 'Unknown Company',
                    companyLocation: row['Company Location'] || 'Unknown Location',
                    budget: parseFloat(row['Budget (Cr ₹)']) || 0,
                    siteLocation: row['Site Location'] || 'Unknown Site',
                    status: row['Status'] || 'Planning'
                };
            });
            
            allProjects = processedData;
            filteredProjects = [...allProjects];
            
            updateStatistics();
            renderProjects();
            
            // If user is signed in, save to Firebase
            if (currentUser) {
                saveProjectsToFirebase(allProjects);
            }
            
            showNotification('Excel data loaded successfully!');
        } catch (error) {
            console.error('Error processing Excel file:', error);
            showNotification('Error processing Excel file. Please check the format.', 'error');
        }
        
        // Reset the file input
        event.target.value = '';
    };
    
    reader.readAsBinaryString(file);
}

function exportDataToExcel() {
    const projectsToExport = filteredProjects.length > 0 ? filteredProjects : allProjects;
    
    // Transform data for export
    const dataForExport = projectsToExport.map(project => {
        return {
            'Project Name': project.projectName,
            'Company Name': project.companyName,
            'Company Location': project.companyLocation,
            'Budget (Cr ₹)': project.budget,
            'Site Location': project.siteLocation,
            'Status': project.status
        };
    });
    
    // Create worksheet
    const worksheet = XLSX.utils.json_to_sheet(dataForExport);
    
    // Create workbook
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Projects');
    
    // Generate Excel file and download
    XLSX.writeFile(workbook, 'Pan_India_Projects_Data.xlsx');
}

function downloadExcelTemplate() {
    // Create template data
    const templateData = [
        {
            'Project Name': 'Example Project',
            'Company Name': 'Example Company',
            'Company Location': 'City, State',
            'Budget (Cr ₹)': 100,
            'Site Location': 'Project Site Location',
            'Status': 'Planning'
        }
    ];
    
    // Create worksheet
    const worksheet = XLSX.utils.json_to_sheet(templateData);
    
    // Create workbook
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Template');
    
    // Generate Excel file and download
    XLSX.writeFile(workbook, 'Pan_India_Projects_Template.xlsx');
}

function clearAllData() {
    if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
        allProjects = [];
        filteredProjects = [];
        
        updateStatistics();
        renderProjects();
        
        // If user is signed in, save empty data to Firebase
        if (currentUser) {
            saveProjectsToFirebase(allProjects);
        }
        
        showNotification('All data cleared successfully!');
    }
}

function syncDataWithFirebase() {
    if (!currentUser) {
        showNotification('Please sign in to sync data', 'error');
        return;
    }
    
    showLoading(true);
    
    loadProjectsFromFirebase()
        .then(projects => {
            if (projects && projects.length > 0) {
                allProjects = projects;
                filteredProjects = [...allProjects];
                
                updateStatistics();
                renderProjects();
                
                showNotification('Data synced from cloud successfully!');
            } else {
                showNotification('No data found in cloud to sync');
            }
            
            showLoading(false);
        })
        .catch(error => {
            console.error('Error syncing data:', error);
            showNotification('Error syncing data from cloud', 'error');
            showLoading(false);
        });
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    // Auth event listeners
    loginBtn.addEventListener('click', signIn);
    logoutBtn.addEventListener('click', signOut);
    
    // Filter event listeners
    resetFiltersBtn.addEventListener('click', resetFilters);
    applyFiltersBtn.addEventListener('click', filterProjects);
    
    // Data management event listeners
    loadSampleBtn.addEventListener('click', loadSampleData);
    excelUpload.addEventListener('change', handleExcelUpload);
    downloadTemplateBtn.addEventListener('click', downloadExcelTemplate);
    exportDataBtn.addEventListener('click', exportDataToExcel);
    clearDataBtn.addEventListener('click', clearAllData);
    syncDataBtn.addEventListener('click', syncDataWithFirebase);
    
    // Initialize the UI
    filteredProjects = [...allProjects];
    renderProjects();
    updateStatistics();
    
    // Auth state changes
    auth.onAuthStateChanged(user => {
        if (user) {
            // User is signed in
            currentUser = user;
            
            // Update UI
            authContainer.style.display = 'none';
            userContainer.style.display = 'block';
            
            // Set user info
            userAvatar.textContent = user.displayName.charAt(0).toUpperCase();
            userName.textContent = user.displayName;
            
            // Enable sync button
            syncDataBtn.disabled = false;
            
            // Load data from Firebase
            loadProjectsFromFirebase()
                .then(projects => {
                    if (projects && projects.length > 0) {
                        allProjects = projects;
                        filteredProjects = [...allProjects];
                        
                        updateStatistics();
                        renderProjects();
                        
                        showNotification('Data loaded from cloud successfully!');
                    }
                });
        } else {
            // User is signed out
            currentUser = null;
            
            // Update UI
            authContainer.style.display = 'block';
            userContainer.style.display = 'none';
            
            // Disable sync button
            syncDataBtn.disabled = true;
            
            // Reset last synced
            lastSynced.textContent = 'Never';
        }
    });
});
